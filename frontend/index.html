<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ¨¡æ€é—®ç­”åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨æ–°è¯é¢˜æŒ‰é’® */
        .header {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .new-chat-btn {
            background: none;
            border: 1px solid #1a73e8;
            color: #1a73e8;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

            .new-chat-btn:hover {
                background-color: #f8f9fa;
            }

        .status-indicator {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ccc;
        }

            .status-dot.online {
                background-color: #4caf50;
                animation: pulse 2s infinite;
            }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 40px 20px;
            transition: all 0.3s ease;
        }

            .main-content.input-at-top {
                justify-content: center;
                align-items: center;
            }

            .main-content.input-at-bottom {
                justify-content: space-between;
                padding-top: 20px;
            }

        /* ä»‹ç»æ–‡å­— */
        .intro-section {
            text-align: center;
            margin-bottom: 40px;
            max-width: 600px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

            .intro-section.hidden {
                opacity: 0;
                pointer-events: none;
                height: 0;
                margin: 0;
            }

        .intro-title {
            font-size: 28px;
            font-weight: 300;
            color: #202124;
            margin-bottom: 16px;
        }

        .intro-subtitle {
            font-size: 16px;
            color: #5f6368;
            line-height: 1.6;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-container {
            flex: 1;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            overflow-y: auto;
            padding: 20px 0;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

            .chat-container.hidden {
                opacity: 0;
                pointer-events: none;
            }

        .message {
            margin-bottom: 24px;
            padding: 0 20px;
            animation: fadeIn 0.3s ease-out;
        }

            .message.user {
                text-align: right;
            }

            .message.bot {
                text-align: left;
            }

        .message-content {
            display: inline-block;
            max-width: 70%;
            text-align: left;
        }

        .user .message-content {
            background-color: #1a73e8;
            color: white;
            padding: 12px 16px;
            border-radius: 18px 18px 4px 18px;
        }

        .bot .message-content {
            background-color: #f8f9fa;
            color: #202124;
            padding: 12px 16px;
            border-radius: 18px 18px 18px 4px;
            border: 1px solid #f0f0f0;
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            background-color: #f8f9fa;
            border-radius: 18px 18px 18px 4px;
            border: 1px solid #f0f0f0;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #9aa0a6;
            animation: typing 1.4s infinite ease-in-out;
        }

            .typing-dot:nth-child(1) {
                animation-delay: -0.32s;
            }

            .typing-dot:nth-child(2) {
                animation-delay: -0.16s;
            }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* è¾“å…¥æ¡†åŒºåŸŸ */
        .input-section {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .input-container {
            position: relative;
            border: 2px solid #1a73e8;
            border-radius: 24px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(26, 115, 232, 0.1);
            transition: all 0.3s ease;
        }

            .input-container:focus-within {
                box-shadow: 0 4px 20px rgba(26, 115, 232, 0.2);
            }

        .input-wrapper {
            display: flex;
            align-items: center;
            padding: 4px;
        }

        textarea {
            flex: 1;
            border: none;
            outline: none;
            padding: 16px 20px;
            font-size: 16px;
            resize: none;
            max-height: 200px;
            min-height: 56px;
            background: transparent;
            color: #202124;
        }

            textarea::placeholder {
                color: #9aa0a6;
            }

        .send-button {
            background-color: #1a73e8;
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

            .send-button:hover:not(:disabled) {
                background-color: #1557b0;
                transform: scale(1.05);
            }

            .send-button:disabled {
                background-color: #c2e7ff;
                cursor: not-allowed;
                transform: none;
            }

        .file-upload-btn {
            background: none;
            border: none;
            color: #5f6368;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            transition: all 0.2s;
        }

            .file-upload-btn:hover {
                background-color: #f8f9fa;
                color: #1a73e8;
            }

        /* æ–‡ä»¶é¢„è§ˆ */
        .file-preview {
            padding: 8px 20px 16px;
            border-top: 1px solid #f0f0f0;
            display: none;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #5f6368;
            font-size: 14px;
        }

        .remove-file {
            color: #dc3545;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
        }

            .remove-file:hover {
                background-color: #ffeef0;
            }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px 16px;
            }

            .intro-title {
                font-size: 24px;
            }

            .message-content {
                max-width: 85%;
            }

            .input-section {
                padding: 0 16px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- é¡¶éƒ¨æ–°è¯é¢˜æŒ‰é’® -->
    <div class="header">
        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus"></i>
            æ–°è¯é¢˜
        </button>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">æ£€æŸ¥è¿æ¥ä¸­...</span>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content input-at-top" id="mainContent">
        <!-- ä»‹ç»æ–‡å­—ï¼ˆåªåœ¨åˆå§‹çŠ¶æ€æ˜¾ç¤ºï¼‰ -->
        <div class="intro-section" id="introSection">
            <h1 class="intro-title">å¤šæ¨¡æ€é—®ç­”åŠ©æ‰‹</h1>
            <p class="intro-subtitle">
                åŸºäº Qwen2-VL-7B å¤šæ¨¡æ€æ¨¡å‹ä¸æœ¬åœ°çŸ¥è¯†åº“<br>
                æ”¯æŒæ–‡å­—è¾“å…¥å’Œå›¾ç‰‡ä¸Šä¼ ï¼Œä¸ºæ‚¨æä¾›å‡†ç¡®ã€åŠæ—¶çš„é—®ç­”æœåŠ¡
            </p>
        </div>

        <!-- èŠå¤©è®°å½•å®¹å™¨ -->
        <div class="chat-container hidden" id="chatContainer"></div>

        <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
        <div class="input-section">
            <div class="input-container">
                <div class="input-wrapper">
                    <button class="file-upload-btn" id="fileUploadBtn" title="ä¸Šä¼ å›¾ç‰‡">
                        <i class="fas fa-image"></i>
                    </button>
                    <textarea id="textInput"
                              placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                              rows="1"></textarea>
                    <button class="send-button" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="file-preview" id="filePreview">
                    <div class="file-info">
                        <span id="fileName"></span>
                        <span class="remove-file" id="removeFile">ç§»é™¤</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="imageUpload" accept="image/*" style="display: none;">

    <script>
        // é…ç½®
        const BACKEND_URL = 'http://localhost:8000';  // åç«¯åœ°å€
        const MAX_RETRIES = 3;  // æœ€å¤§é‡è¯•æ¬¡æ•°
        const TIMEOUT = 30000;  // 30ç§’è¶…æ—¶

        // DOMå…ƒç´ 
        const mainContent = document.getElementById('mainContent');
        const introSection = document.getElementById('introSection');
        const chatContainer = document.getElementById('chatContainer');
        const textInput = document.getElementById('textInput');
        const sendButton = document.getElementById('sendButton');
        const fileUploadBtn = document.getElementById('fileUploadBtn');
        const imageUpload = document.getElementById('imageUpload');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const removeFile = document.getElementById('removeFile');
        const newChatBtn = document.getElementById('newChatBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        let selectedImage = null;
        let hasMessages = false;
        let currentRequestController = null;

        // æ£€æŸ¥åç«¯è¿æ¥çŠ¶æ€
        async function checkBackendStatus() {
            try {
                // å°è¯•è®¿é—®åç«¯çŠ¶æ€æ¥å£æˆ–æ ¹è·¯å¾„
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${BACKEND_URL}/`, {
                    method: 'GET',
                    signal: controller.signal
                }).finally(() => clearTimeout(timeoutId));

                if (response.status !== 404) {
                    updateStatus('online', 'æœåŠ¡åœ¨çº¿');
                    return true;
                }

                // å°è¯• /status æ¥å£
                const response2 = await fetch(`${BACKEND_URL}/status`, {
                    method: 'GET',
                    signal: controller.signal
                }).finally(() => clearTimeout(timeoutId));

                if (response2.ok) {
                    updateStatus('online', 'æœåŠ¡åœ¨çº¿');
                    return true;
                }

                updateStatus('offline', 'æœåŠ¡ç¦»çº¿');
                return false;

            } catch (error) {
                console.log('åç«¯è¿æ¥æ£€æŸ¥å¤±è´¥:', error.message);
                updateStatus('offline', 'æœåŠ¡ç¦»çº¿');
                return false;
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status, message) {
            statusDot.className = 'status-dot ' + (status === 'online' ? 'online' : '');
            statusText.textContent = message;
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        textInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // ä¸Šä¼ å›¾ç‰‡
        fileUploadBtn.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedImage = file;
                fileName.textContent = file.name;
                filePreview.style.display = 'block';

                // è°ƒæ•´è¾“å…¥æ¡†å®¹å™¨æ ·å¼
                const inputContainer = document.querySelector('.input-container');
                inputContainer.style.borderRadius = '24px 24px 12px 12px';
            } else if (file) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ (JPG, PNG, GIFç­‰)');
            }
        });

        // ç§»é™¤æ–‡ä»¶
        removeFile.addEventListener('click', () => {
            selectedImage = null;
            imageUpload.value = '';
            filePreview.style.display = 'none';
            fileName.textContent = '';

            // æ¢å¤è¾“å…¥æ¡†å®¹å™¨æ ·å¼
            const inputContainer = document.querySelector('.input-container');
            inputContainer.style.borderRadius = '24px';
        });

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(content, image, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (image) {
                const imgInfo = document.createElement('div');
                imgInfo.innerHTML = `<strong>ğŸ“ å›¾ç‰‡é™„ä»¶:</strong> ${image.name}`;
                imgInfo.style.marginBottom = '8px';
                imgInfo.style.fontSize = '14px';
                contentDiv.appendChild(imgInfo);

                const reader = new FileReader();
                reader.onload = function (event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.alt = 'ä¸Šä¼ çš„å›¾ç‰‡';
                    img.style.maxWidth = '200px';
                    img.style.borderRadius = '8px';
                    img.style.marginTop = '8px';
                    contentDiv.appendChild(img);
                };
                reader.readAsDataURL(image);
            }

            if (content) {
                const text = document.createElement('div');
                text.innerHTML = content.replace(/\n/g, '<br>');
                contentDiv.appendChild(text);
            }

            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // å¦‚æœæœ‰æ¶ˆæ¯ï¼Œè°ƒæ•´å¸ƒå±€
            if (!hasMessages) {
                hasMessages = true;
                mainContent.classList.remove('input-at-top');
                mainContent.classList.add('input-at-bottom');
                introSection.classList.add('hidden');
                chatContainer.classList.remove('hidden');
            }
        }

        // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'typing-indicator';

            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                contentDiv.appendChild(dot);
            }

            typingDiv.appendChild(contentDiv);
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ç§»é™¤æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // å‘é€æ¶ˆæ¯åˆ°åç«¯
        async function sendMessage() {
            const question = textInput.value.trim();
            if (!question && !selectedImage) {
                alert('è¯·è¾“å…¥é—®é¢˜æˆ–é€‰æ‹©å›¾ç‰‡');
                return;
            }

            if (sendButton.disabled) return;

            // ç¦ç”¨å‘é€æŒ‰é’®
            sendButton.disabled = true;

            // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚ï¼ˆå¦‚æœæœ‰ï¼‰
            if (currentRequestController) {
                currentRequestController.abort();
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(question, selectedImage, true);

            // ä¿å­˜å›¾ç‰‡å¼•ç”¨ï¼ˆç”¨äºæ¸…é™¤ï¼‰
            const currentImage = selectedImage;

            // æ¸…é™¤è¾“å…¥
            textInput.value = '';
            textInput.style.height = 'auto';

            // æ¸…é™¤æ–‡ä»¶é€‰æ‹©ï¼ˆä½†ä¿ç•™å›¾ç‰‡æ•°æ®ç”¨äºå‘é€ï¼‰
            imageUpload.value = '';
            filePreview.style.display = 'none';
            fileName.textContent = '';
            const inputContainer = document.querySelector('.input-container');
            inputContainer.style.borderRadius = '24px';

            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            showTypingIndicator();

            let retries = 0;
            let success = false;

            // é‡è¯•æœºåˆ¶
            while (retries < MAX_RETRIES && !success) {
                try {
                    currentRequestController = new AbortController();
                    const timeoutId = setTimeout(() => currentRequestController.abort(), TIMEOUT);

                    // å‡†å¤‡è¡¨å•æ•°æ®
                    const formData = new FormData();
                    if (question) formData.append('question', question);
                    if (currentImage) formData.append('image', currentImage);

                    // å‘é€åˆ°åç«¯
                    const response = await fetch(`${BACKEND_URL}/chat`, {
                        method: 'POST',
                        body: formData,
                        signal: currentRequestController.signal
                    }).finally(() => clearTimeout(timeoutId));

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
                    removeTypingIndicator();

                    // æ·»åŠ AIå›å¤
                    if (data.data.answer) {
                        addMessage(data.data.answer, null, false);
                    } else {
                        addMessage('æ”¶åˆ°å›å¤ä½†å†…å®¹ä¸ºç©º', null, false);
                    }

                    success = true;
                    updateStatus('online', 'æœåŠ¡åœ¨çº¿');

                } catch (error) {
                    retries++;

                    if (error.name === 'AbortError') {
                        // è¶…æ—¶æˆ–æ‰‹åŠ¨å–æ¶ˆ
                        if (retries < MAX_RETRIES) {
                            console.log(`è¯·æ±‚è¶…æ—¶ï¼Œé‡è¯• ${retries}/${MAX_RETRIES}...`);
                            continue;
                        }
                        removeTypingIndicator();
                        addMessage('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•', null, false);

                    } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        // ç½‘ç»œé”™è¯¯
                        if (retries < MAX_RETRIES) {
                            console.log(`ç½‘ç»œé”™è¯¯ï¼Œé‡è¯• ${retries}/${MAX_RETRIES}...`);
                            await new Promise(resolve => setTimeout(resolve, 1000 * retries));
                            continue;
                        }
                        removeTypingIndicator();
                        addMessage(`æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨\nè¯·æ£€æŸ¥ï¼š\n1. åç«¯æ˜¯å¦è¿è¡Œåœ¨ ${BACKEND_URL}\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸`, null, false);
                        updateStatus('offline', 'è¿æ¥å¤±è´¥');

                    } else {
                        // å…¶ä»–é”™è¯¯
                        removeTypingIndicator();
                        addMessage(`è¯·æ±‚å¤±è´¥: ${error.message}`, null, false);
                        updateStatus('offline', 'æœåŠ¡å¼‚å¸¸');
                    }
                }
            }

            // é‡ç½®çŠ¶æ€
            sendButton.disabled = false;
            textInput.focus();
            currentRequestController = null;
            selectedImage = null;
        }

        // æ–°è¯é¢˜åŠŸèƒ½
        function newChat() {
            if (hasMessages) {
                if (confirm('ç¡®å®šè¦å¼€å§‹æ–°è¯é¢˜å—ï¼Ÿå½“å‰å¯¹è¯å°†è¢«æ¸…ç©ºã€‚')) {
                    // æ¸…ç©ºèŠå¤©è®°å½•
                    chatContainer.innerHTML = '';

                    // é‡ç½®çŠ¶æ€
                    hasMessages = false;
                    selectedImage = null;
                    imageUpload.value = '';
                    textInput.value = '';
                    textInput.style.height = 'auto';
                    filePreview.style.display = 'none';
                    fileName.textContent = '';

                    // æ¢å¤åˆå§‹å¸ƒå±€
                    mainContent.classList.remove('input-at-bottom');
                    mainContent.classList.add('input-at-top');
                    introSection.classList.remove('hidden');
                    chatContainer.classList.add('hidden');

                    // æ¢å¤è¾“å…¥æ¡†æ ·å¼
                    const inputContainer = document.querySelector('.input-container');
                    inputContainer.style.borderRadius = '24px';

                    textInput.focus();
                }
            }
        }

        // äº‹ä»¶ç›‘å¬
        sendButton.addEventListener('click', sendMessage);

        textInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        newChatBtn.addEventListener('click', newChat);

        // åˆå§‹åŒ–
        async function init() {
            textInput.focus();

            // æ£€æŸ¥åç«¯çŠ¶æ€
            await checkBackendStatus();

            // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
            setInterval(checkBackendStatus, 30000);

            // é¡µé¢å¯è§æ—¶æ£€æŸ¥çŠ¶æ€
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    checkBackendStatus();
                }
            });
        }

        // å¯åŠ¨åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
